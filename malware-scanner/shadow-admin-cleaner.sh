#!/bin/bash

# ==============================================================================
# WordPress Malware Scanner & Forensics Tool (V8 - Automated Cleanup)
# Target: /var/www/domains/msslearning.com/public_html 
# Should be run if the shadow-admin-finder.sh found any malicious admins
# ==============================================================================

TARGET_DIR="/var/www/domains/msslearning.com/public_html"
LOG_FILE="/var/log/wp_forensics_$(date +%F).log"
ROGUE_USER_ID="106" # Based on your forensic log
ROGUE_USER_LOGIN="system4ff437f7"

# Enhanced Log Discovery
LOG_PATHS=(
    "/var/log/apache2/access.log"
    "/var/log/nginx/access.log"
    "/var/log/httpd/access_log"
    "/var/www/domains/msslearning.com/logs/access.log"
    "/var/log/apache2/other_vhosts_access.log"
)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Starting Deep Root Cause Analysis & Cleanup...${NC}"
echo "Forensics Report - $(date)" > "$LOG_FILE"

# 1. FIND RECENTLY CREATED DIRECTORIES
echo -e "${YELLOW}[1/6] Detecting newly created plugin/theme folders...${NC}"
find "$TARGET_DIR/wp-content/plugins" "$TARGET_DIR/wp-content/themes" -maxdepth 2 -ctime -7 -printf "Created: %Tc - %p\n" >> "$LOG_FILE"

# 2. DEEP LOG CORRELATION
echo -e "${YELLOW}[2/6] Correlating file changes with web access logs...${NC}"
SUSPICIOUS_FILE="$TARGET_DIR/wp-content/themes/twentytwentyfive/functions.php"

if [ -f "$SUSPICIOUS_FILE" ]; then
    MOD_TIME="00:10" # Locked from forensics
    T_MINUS_1=$(date -d "today $MOD_TIME 1 minute ago" +%H:%M)
    T_PLUS_1=$(date -d "today $MOD_TIME 1 minute" +%H:%M)
    SEARCH_PATTERN="$MOD_TIME|$T_MINUS_1|$T_PLUS_1"
    
    for LOG in "${LOG_PATHS[@]}"; do
        if [ -f "$LOG" ]; then
            grep -E "$SEARCH_PATTERN" "$LOG" | grep -E "POST|xmlrpc|admin-ajax|wp-login|wp-admin" >> "$LOG_FILE"
        fi
    done
fi

# 3. DATABASE CLEANUP (Remove Rogue Admin)
if command -v wp &> /dev/null; then
    echo -e "${RED}[3/6] REMOVING ROGUE ADMINISTRATOR...${NC}"
    # Verify user exists before deleting
    USER_EXISTS=$(wp user get "$ROGUE_USER_ID" --path="$TARGET_DIR" --allow-root 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo "Deleting Rogue User: $ROGUE_USER_LOGIN (ID: $ROGUE_USER_ID)" >> "$LOG_FILE"
        wp user delete "$ROGUE_USER_ID" --reassign=1 --path="$TARGET_DIR" --allow-root >> "$LOG_FILE" 2>&1
        echo -e "${GREEN}SUCCESS: Rogue user $ROGUE_USER_LOGIN removed.${NC}"
    else
        echo "Rogue user $ROGUE_USER_LOGIN already removed or not found." >> "$LOG_FILE"
    fi
fi

# 4. THEME CLEANUP (Strip eval/base64 from functions.php)
echo -e "${RED}[4/6] CLEANING THEME BACKDOORS...${NC}"
if [ -f "$SUSPICIOUS_FILE" ]; then
    # Create backup first
    cp "$SUSPICIOUS_FILE" "${SUSPICIOUS_FILE}.bak"
    # Remove lines containing common malware signatures
    sed -i '/eval(base64_decode/d' "$SUSPICIOUS_FILE"
    sed -i '/str_rot13/d' "$SUSPICIOUS_FILE"
    echo "Cleaned $SUSPICIOUS_FILE (Backup created at .bak)" >> "$LOG_FILE"
    echo -e "${GREEN}SUCCESS: Backdoor patterns removed from functions.php.${NC}"
fi

# 5. CHECK FOR CONFIGURATION EXPOSURE
echo -e "${YELLOW}[5/6] Checking for configuration exposure...${NC}"
find "$TARGET_DIR" \( -name "wp-config.php" -o -name ".htaccess" \) -perm -o+w >> "$LOG_FILE"

# 6. SCAN FOR REMAINING PERSISTENCE
echo -e "${YELLOW}[6/6] Final Persistence Scan...${NC}"
grep -rnE "(eval\(|base64_decode\(|gzinflate\(|str_rot13\()" "$TARGET_DIR/index.php" "$TARGET_DIR/wp-config.php" >> "$LOG_FILE"

echo -e "\n${GREEN}Cleanup & Forensics Complete!${NC}"
echo -e "Review report: ${YELLOW}$LOG_FILE${NC}"

# Final Recommendation
echo -e "\n${BLUE}--- FINAL STEPS ---${NC}"
echo -e "1. ${YELLOW}Change password${NC} for 'md.saadawy' immediately."
echo -e "2. Disable XML-RPC if not needed."
echo -e "3. Install a fresh copy of the 'twentytwentyfive' theme to be 100% safe."
