#!/bin/bash

echo "================================================"
echo "WordPress Malware Scanner"
echo "================================================"
echo ""

SITE_PATH="/var/www/domains/msslearning.com/public_html"

# Check if Monarx has any quarantined files
echo "[1] MONARX QUARANTINE:"
echo "-------------------------------------------"
if [ -d /var/lib/monarx ]; then
    echo "Checking Monarx quarantine..."
    find /var/lib/monarx -type f 2>/dev/null | head -n 20
else
    echo "No Monarx quarantine directory found"
fi
echo ""

# Look for recently modified PHP files (common malware indicator)
echo "[2] RECENTLY MODIFIED PHP FILES (last 30 days):"
echo "-------------------------------------------"
if [ -d "$SITE_PATH" ]; then
    echo "Files modified in last 30 days:"
    find "$SITE_PATH" -name "*.php" -type f -mtime -30 -ls 2>/dev/null | head -n 20
else
    echo "Site path not found"
fi
echo ""

# Look for suspicious file names
echo "[3] SUSPICIOUS FILE NAMES:"
echo "-------------------------------------------"
echo "Common malware file patterns:"
find "$SITE_PATH" -type f \( \
    -name "*malware*" -o \
    -name "*backdoor*" -o \
    -name "*shell*" -o \
    -name "c99*" -o \
    -name "r57*" -o \
    -name "*.suspected" -o \
    -name "*.bak.php" -o \
    -name ".*.php" -o \
    -name "wp-includes/wp-tmp.php" -o \
    -name "wp-includes/class-wp-theme.php" \
\) 2>/dev/null
echo ""

# Look for base64_decode (common in malware)
echo "[4] FILES WITH base64_decode (malware obfuscation):"
echo "-------------------------------------------"
echo "Scanning for base64_decode in PHP files..."
grep -r "base64_decode" "$SITE_PATH" --include="*.php" 2>/dev/null | head -n 10
echo ""

# Look for eval() usage (can be malicious)
echo "[5] FILES WITH eval() (potential backdoors):"
echo "-------------------------------------------"
echo "Scanning for eval() in PHP files..."
grep -r "eval(" "$SITE_PATH" --include="*.php" 2>/dev/null | head -n 10
echo ""

# Check for files in wp-includes that shouldn't be there
echo "[6] SUSPICIOUS FILES IN wp-includes:"
echo "-------------------------------------------"
if [ -d "$SITE_PATH/wp-includes" ]; then
    echo "PHP files that shouldn't be in wp-includes:"
    find "$SITE_PATH/wp-includes" -maxdepth 1 -name "*.php" -type f 2>/dev/null | grep -v -E "(class-|deprecated|functions|template-loader)"
fi
echo ""

# Check uploads directory for PHP files (should not have any)
echo "[7] PHP FILES IN UPLOADS (major red flag!):"
echo "-------------------------------------------"
if [ -d "$SITE_PATH/wp-content/uploads" ]; then
    echo "PHP files found in uploads directory:"
    find "$SITE_PATH/wp-content/uploads" -name "*.php" -type f 2>/dev/null
    
    count=$(find "$SITE_PATH/wp-content/uploads" -name "*.php" -type f 2>/dev/null | wc -l)
    if [ "$count" -gt 0 ]; then
        echo ""
        echo "⚠️  CRITICAL: $count PHP files found in uploads!"
        echo "These should NOT exist and are likely malware!"
    else
        echo "✓ No PHP files in uploads (good)"
    fi
else
    echo "Uploads directory not found"
fi
echo ""

# Check for hidden files
echo "[8] HIDDEN FILES (.filename):"
echo "-------------------------------------------"
echo "Hidden PHP files in site root:"
find "$SITE_PATH" -maxdepth 1 -name ".*" -type f 2>/dev/null
echo ""

# Check file permissions (writable by others is bad)
echo "[9] WORLD-WRITABLE PHP FILES:"
echo "-------------------------------------------"
echo "PHP files writable by anyone:"
find "$SITE_PATH" -name "*.php" -type f -perm -002 2>/dev/null | head -n 10
echo ""

# Check for common backdoor locations
echo "[10] COMMON BACKDOOR LOCATIONS:"
echo "-------------------------------------------"
common_backdoors=(
    "$SITE_PATH/wp-admin/css/colors/blue/backdoor.php"
    "$SITE_PATH/wp-admin/network/menu.php"
    "$SITE_PATH/wp-includes/wp-tmp.php"
    "$SITE_PATH/wp-includes/SimplePie/Parse/Class.php"
    "$SITE_PATH/.well-known/.invisible/shell.php"
)

for file in "${common_backdoors[@]}"; do
    if [ -f "$file" ]; then
        echo "⚠️  FOUND: $file"
    fi
done
echo ""

# Check all sites on server
echo "[11] SCANNING ALL SITES ON SERVER:"
echo "-------------------------------------------"
if [ -d /var/www/domains ]; then
    echo "All domains on this server:"
    ls -la /var/www/domains/
    echo ""
    
    echo "Checking each site for PHP in uploads..."
    for domain in /var/www/domains/*/public_html/wp-content/uploads; do
        if [ -d "$domain" ]; then
            site=$(echo "$domain" | cut -d'/' -f5)
            count=$(find "$domain" -name "*.php" -type f 2>/dev/null | wc -l)
            if [ "$count" -gt 0 ]; then
                echo "⚠️  $site: $count PHP files in uploads!"
                find "$domain" -name "*.php" -type f 2>/dev/null
            else
                echo "✓ $site: Clean"
            fi
        fi
    done
fi
echo ""

echo "================================================"
echo "Scan Complete"
echo "================================================"
echo ""
echo "NEXT STEPS:"
echo "1. Review any files flagged above"
echo "2. Check Hostinger dashboard for specific files they flagged"
echo "3. Delete any PHP files in uploads directories"
echo "4. Remove any backdoor files found"
echo "5. Update all WordPress core, plugins, and themes"
echo ""
echo "AFTER CLEANUP:"
echo "Contact Hostinger to request network restriction removal"
echo ""
