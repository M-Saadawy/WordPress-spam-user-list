#!/bin/bash

# ==============================================================================
# WordPress Malware Scanner & Forensics Tool (V9 - Hardening & Prevention)
# Target: /var/www/domains/msslearning.com/public_html
# ==============================================================================

TARGET_DIR="/var/www/domains/msslearning.com/public_html"
LOG_FILE="/var/log/wp_forensics_$(date +%F).log"
MAIN_ADMIN="md.saadawy"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Starting Security Hardening Phase...${NC}"
echo "Hardening Report - $(date)" >> "$LOG_FILE"

# 1. DISABLE XML-RPC (Attack Vector Prevention)
echo -e "${YELLOW}[1/4] Disabling XML-RPC via .htaccess...${NC}"
HTACCESS="$TARGET_DIR/.htaccess"
if [ -f "$HTACCESS" ]; then
    if ! grep -q "xmlrpc.php" "$HTACCESS"; then
        cat <<EOT >> "$HTACCESS"

# Block WordPress xmlrpc.php requests
<Files xmlrpc.php>
order deny,allow
deny from all
</Files>
EOT
        echo "XML-RPC blocked in .htaccess" >> "$LOG_FILE"
        echo -e "${GREEN}SUCCESS: XML-RPC disabled.${NC}"
    else
        echo "XML-RPC already blocked." >> "$LOG_FILE"
    fi
fi

# 2. FORCE PASSWORD RESET FOR ADMIN
if command -v wp &> /dev/null; then
    echo -e "${YELLOW}[2/4] Resetting password for $MAIN_ADMIN...${NC}"
    NEW_PASS=$(openssl rand -base64 16)
    wp user update "$MAIN_ADMIN" --user_pass="$NEW_PASS" --path="$TARGET_DIR" --allow-root >> "$LOG_FILE" 2>&1
    echo -e "${RED}IMPORTANT: Password for $MAIN_ADMIN has been reset to: ${NC}${GREEN}$NEW_PASS${NC}"
    echo "Password reset for $MAIN_ADMIN" >> "$LOG_FILE"
fi

# 3. VERIFY FILE PERMISSIONS
echo -e "${YELLOW}[3/4] Correcting file permissions...${NC}"
# Secure wp-config.php
chmod 600 "$TARGET_DIR/wp-config.php"
# Secure directories
find "$TARGET_DIR" -type d -exec chmod 755 {} \;
# Secure files
find "$TARGET_DIR" -type f -exec chmod 644 {} \;
echo "Permissions reset to 755/644" >> "$LOG_FILE"
echo -e "${GREEN}SUCCESS: Permissions hardened.${NC}"

# 4. FINAL INTEGRITY CHECK
echo -e "${YELLOW}[4/4] Verifying Core WordPress Checksums...${NC}"
if command -v wp &> /dev/null; then
    wp core verify-checksums --path="$TARGET_DIR" --allow-root >> "$LOG_FILE" 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}SUCCESS: WordPress Core is clean.${NC}"
    else
        echo -e "${RED}WARNING: Core checksums failed. Check logs.${NC}"
    fi
fi

echo -e "\n${BLUE}--- STATUS UPDATE ---${NC}"
echo -e "Rogue User: ${GREEN}DELETED${NC}"
echo -e "Theme Backdoor: ${GREEN}CLEANED${NC}"
echo -e "XML-RPC: ${GREEN}DISABLED${NC}"
echo -e "Admin Password: ${RED}RESET (See above)${NC}"
echo -e "\nFull report available at: ${YELLOW}$LOG_FILE${NC}"
