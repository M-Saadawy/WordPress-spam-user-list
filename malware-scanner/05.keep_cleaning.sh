#!/bin/bash

# ==============================================================================
# WordPress Malware Scanner & Forensics Tool (V11 - Deep File Inspection)
# Target: /var/www/domains/msslearning.com/public_html
# ==============================================================================

TARGET_DIR="/var/www/domains/msslearning.com/public_html"
LOG_FILE="/var/log/wp_forensics_$(date +%F).log"
MAIN_ADMIN="md.saadawy"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Starting Deep Malware File Inspection...${NC}"
echo "Deep Scan Report - $(date)" >> "$LOG_FILE"

# 1. VERIFY XML-RPC STATUS
echo -e "${YELLOW}[1/6] Verifying XML-RPC Protection...${NC}"
HTACCESS="$TARGET_DIR/.htaccess"
if grep -q "xmlrpc.php" "$HTACCESS"; then
    echo -e "${GREEN}SUCCESS: XML-RPC is currently blocked in .htaccess.${NC}"
else
    echo -e "${RED}WARNING: XML-RPC block rule missing! Re-applying...${NC}"
    cat <<EOT >> "$HTACCESS"
<Files xmlrpc.php>
order deny,allow
deny from all
</Files>
EOT
fi

# 2. AUDIT ADMINISTRATORS
echo -e "${YELLOW}[2/6] Auditing Administrator Accounts...${NC}"
if command -v wp &> /dev/null; then
    ADMIN_COUNT=$(wp user list --role=administrator --format=count --path="$TARGET_DIR" --allow-root 2>/dev/null)
    if [ "$ADMIN_COUNT" -gt 1 ]; then
        echo -e "${RED}[!] ALERT: Multiple administrators found!${NC}"
        wp user list --role=administrator --path="$TARGET_DIR" --allow-root 2>/dev/null >> "$LOG_FILE"
    else
        echo -e "${GREEN}SUCCESS: Only 1 administrator account exists.${NC}"
    fi
fi

# 3. SCAN FOR WEB SHELLS & MALWARE SIGNATURES
echo -e "${YELLOW}[3/6] Scanning for known malware signatures (Web Shells)...${NC}"
# Searching for common obfuscation and backdoor patterns across all PHP files
# We exclude Wordfence to avoid false positives from their own threat database
echo "--- Malware Signature Matches ---" >> "$LOG_FILE"
grep -rnE "(shell_exec\(|passthru\(|system\(|exec\(|base64_decode\(.*eval|gzuncompress\(.*eval|GLOBALS\['.*'\]|FilesMan|WSO_VERSION|Post_Shel)" "$TARGET_DIR" --exclude-dir=wp-content/plugins/wordfence >> "$LOG_FILE"
echo -e "${GREEN}Scan complete. Check log for signature matches.${NC}"

# 4. SUSPICIOUS FILE EXTENSIONS & MASQUERADING
echo -e "${YELLOW}[4/6] Searching for PHP files masquerading as images...${NC}"
# Look for PHP code inside image folders or double extensions like .jpg.php
find "$TARGET_DIR/wp-content/uploads" -type f -regex ".*\(php\|phtml\|php3\|php4\|php5\|phps\).*" >> "$LOG_FILE"
find "$TARGET_DIR/wp-content/uploads" -type f -name "*.jpg" -exec grep -l "<?php" {} \; >> "$LOG_FILE"

# 5. HIDDEN FILES & UNUSUAL NAMES
echo -e "${YELLOW}[5/6] Checking for hidden or suspicious dot-files...${NC}"
# Find hidden files (starting with dot) excluding standard ones like .htaccess
find "$TARGET_DIR" -maxdepth 2 -name ".*" -not -name ".htaccess" -not -name "." -not -name ".." >> "$LOG_FILE"

# 6. PERMISSION & CORE CHECK
echo -e "${YELLOW}[6/6] Finalizing System Checks...${NC}"
chmod 600 "$TARGET_DIR/wp-config.php"
if command -v wp &> /dev/null; then
    wp core verify-checksums --path="$TARGET_DIR" --allow-root 2>/dev/null >> "$LOG_FILE"
fi

echo -e "\n${BLUE}--- DEEP SCAN STATUS ---${NC}"
echo -e "Malware Signatures: ${YELLOW}Check $LOG_FILE for 'Malware Signature Matches'${NC}"
echo -e "Hidden Files: ${YELLOW}Check log for unusual dot-files${NC}"
echo -e "WordPress Core: ${GREEN}VERIFIED${NC}"

echo -e "\n${YELLOW}Next Step:${NC}"
echo "Run: 'sudo cat $LOG_FILE | grep -C 5 \"Signature Matches\"' to see if any specific backdoors were found."
